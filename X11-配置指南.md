# WSL2 + X11 + Electron 完整配置指南

## 📋 概述
本指南帮助你在WSL2环境中运行Electron桌面应用,需要配置X11图形界面转发。

---

## ⚠️ 重要前提

**确保以下事项完成:**
- ✅ WSL2已安装并正常运行
- ✅ Windows系统版本: Windows 10 2004+ 或 Windows 11
- ✅ 项目依赖已安装: `npm install`

---

## 📦 步骤1: 安装Windows X服务器 (VcXsrv)

### 方式A: 使用浏览器下载

1. 访问: https://sourceforge.net/projects/vcxsrv/
2. 下载最新版本的安装程序
3. 运行安装,一路点击 "Next"

### 方式B: 使用Windows包管理器 (推荐)

在Windows PowerShell或CMD中运行:

```powershell
winget install --id marha.VcXsrv
```

---

## 🚀 步骤2: 启动并配置VcXsrv

**在Windows中启动 XLaunch** (开始菜单搜索 "XLaunch"):

### 配置页面1: Display settings
- 选择: **Multiple windows**
- Display number: **0**
- 点击 "Next"

### 配置页面2: Client startup
- 选择: **Start no client**
- 点击 "Next"

### 配置页面3: Extra settings ⚠️ 关键设置
- ✅ **必须勾选**: "Disable access control"
- ✅ **建议勾选**: "Native opengl"
- 点击 "Next"

### 配置页面4: Finish
- (可选) 点击 "Save configuration" 保存配置,下次直接加载
- 点击 "Finish" 启动

**验证**: 系统托盘应该出现一个 **X图标**,表示VcXsrv正在运行。

---

## 🔥 步骤3: 配置Windows防火墙

VcXsrv需要允许WSL2连接,必须配置防火墙:

### 方式A: 自动添加规则 (推荐)

在Windows PowerShell (管理员) 中运行:

```powershell
# 允许VcXsrv接受WSL2连接
New-NetFirewallRule -DisplayName "VcXsrv" -Direction Inbound -Program "C:\Program Files\VcXsrv\vcxsrv.exe" -Action Allow
```

### 方式B: 手动添加规则

1. 打开 "Windows Defender 防火墙"
2. 点击 "高级设置"
3. 选择 "入站规则" -> "新建规则"
4. 规则类型: 程序
5. 程序路径: `C:\Program Files\VcXsrv\vcxsrv.exe`
6. 操作: 允许连接
7. 配置文件: 全选
8. 名称: VcXsrv

---

## 🐧 步骤4: 配置WSL2环境变量

X11环境变量已自动添加到 `~/.bashrc`。

**手动验证配置**:

```bash
tail -10 ~/.bashrc
```

应该看到:

```bash
# === WSL2 X11 配置 ===
export DISPLAY=$(ip route show | grep default | awk '{print $3}'):0
export LIBGL_ALWAYS_INDIRECT=1
export ELECTRON_ENABLE_LOGGING=1
export ELECTRON_DISABLE_GPU=1
```

---

## 🧪 步骤5: 测试X11连接

在WSL2终端中运行:

```bash
# 加载环境变量
source ~/.bashrc

# 测试X11连接
xdpyinfo | head -5
```

**成功输出示例**:

```
name of display:    192.168.x.x:0
version number:    11.0
vendor string:    ...
```

**如果失败**,检查:
- ✅ VcXsrv正在运行 (系统托盘有X图标)
- ✅ 防火墙规则已添加
- ✅ VcXsrv配置中勾选了 "Disable access control"

---

## 🎯 步骤6: 启动Electron应用

### 使用启动脚本 (推荐)

```bash
cd /home/wcp/项目集合/公众号桌面应用
./start-with-x11.sh
```

启动脚本会:
1. 自动配置环境变量
2. 测试X11连接
3. 清理旧进程
4. 启动应用

### 手动启动

```bash
cd /home/wcp/项目集合/公众号桌面应用

# 设置环境变量
export DISPLAY=$(ip route show | grep default | awk '{print $3}'):0
export LIBGL_ALWAYS_INDIRECT=1
export ELECTRON_DISABLE_GPU=1

# 启动应用
npm run dev
```

---

## ✅ 步骤7: 验证应用正常运行

应用启动后,应该看到:

1. **WSL2终端输出**:
   ```
   dev server running for the electron renderer process at:
   ➜  Local:   http://localhost:5173/
   start electron app...
   [Main] 应用准备完成
   [Main] ✅ 主窗口创建完成
   ```

2. **Windows桌面**: 出现Electron应用窗口

3. **系统托盘**: VcXsrv图标仍在运行

---

## 🔧 故障排除

### 问题1: "unable to open display"

**原因**: X11服务器未运行或连接失败

**解决**:
1. 确认VcXsrv正在运行
2. 重新启动VcXsrv,确保勾选 "Disable access control"
3. 检查防火墙规则
4. 验证DISPLAY变量: `echo $DISPLAY` (应显示类似 `192.168.x.x:0`)

### 问题2: "ReferenceError: File is not defined"

**原因**: 某些Node模块与Electron版本不兼容

**解决**:
```bash
# 确保环境变量已设置
export ELECTRON_DISABLE_GPU=1
npm run dev
```

### 问题3: 窗口显示但无响应

**原因**: GPU加速问题

**解决**:
```bash
export LIBGL_ALWAYS_INDIRECT=1
export ELECTRON_DISABLE_GPU=1
npm run dev
```

### 问题4: VcXsrv启动后立即关闭

**原因**: 端口冲突或配置错误

**解决**:
1. 关闭所有VcXsrv进程: 任务管理器 -> 结束 vcxsrv.exe
2. 重新运行XLaunch配置
3. 确保Display number设置为 0

---

## 💡 高级技巧

### 自动启动VcXsrv

创建Windows快捷方式,参数:

```
"C:\Program Files\VcXsrv\vcxsrv.exe" :0 -multiwindow -clipboard -wgl -ac
```

将快捷方式放入启动文件夹: `Win+R` -> `shell:startup`

### 保存VcXsrv配置

在XLaunch最后一步点击 "Save configuration",保存为 `config.xlaunch`,下次双击直接启动。

### 测试X11应用

安装简单的X11应用测试:

```bash
sudo apt install x11-apps
xeyes  # 应该弹出一个眼睛跟随鼠标的窗口
```

---

## 📚 相关资源

- VcXsrv官网: https://sourceforge.net/projects/vcxsrv/
- WSL2文档: https://docs.microsoft.com/zh-cn/windows/wsl/
- Electron文档: https://www.electronjs.org/docs

---

## 🎉 完成

配置完成后,使用以下命令启动应用:

```bash
cd /home/wcp/项目集合/公众号桌面应用
./start-with-x11.sh
```

或者添加到 `.bashrc` 的别名:

```bash
alias start-app='cd /home/wcp/项目集合/公众号桌面应用 && ./start-with-x11.sh'
```

然后直接运行 `start-app` 即可! 🚀
