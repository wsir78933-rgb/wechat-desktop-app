# 项目结构说明

## 完整目录树

```
公众号桌面应用/
├── package.json                    # 项目配置和依赖
├── dosc/                           # 项目文档
│   ├── 需求文档.md
│   ├── 技术文档.md
│   ├── IPC通信架构文档.md          ✅ 新增：IPC架构详细说明
│   ├── IPC-README.md               ✅ 新增：快速开始指南
│   └── 项目结构说明.md             ✅ 新增：本文档
│
└── src/                            # 源代码目录
    ├── types/                      ✅ 新增：共享类型定义
    │   └── ipc.ts                  # IPC通信类型定义
    │
    ├── main/                       # 主进程代码
    │   ├── index.ts                ✅ 已更新：主进程入口 + IPC注册
    │   │
    │   ├── ipc/                    ✅ 新增：IPC处理器模块
    │   │   ├── index.ts            # 统一注册/清理IPC处理器
    │   │   ├── article.ts          # 文章相关IPC处理器
    │   │   ├── tag.ts              # 标签相关IPC处理器
    │   │   ├── search.ts           # 搜索相关IPC处理器
    │   │   └── system.ts           # 系统相关IPC处理器
    │   │
    │   ├── database/               # 数据库模块（已有）
    │   │   ├── index.ts
    │   │   ├── db.ts
    │   │   ├── articleService.ts
    │   │   ├── tagService.ts
    │   │   └── searchService.ts
    │   │
    │   ├── scrapers/               # 爬虫模块（已有）
    │   │   ├── index.ts
    │   │   ├── types.ts
    │   │   ├── wechat.ts
    │   │   ├── example.ts
    │   │   └── test.ts
    │   │
    │   └── windows/                # 窗口管理（已有）
    │       ├── index.ts
    │       ├── types.ts
    │       ├── mainWindow.ts
    │       ├── floatWindow.ts
    │       └── windowManager.ts
    │
    ├── preload/                    # Preload脚本
    │   └── index.ts                ✅ 已更新：安全API桥接
    │
    └── renderer/                   # 渲染进程代码
        └── src/
            ├── main.tsx            # 渲染进程入口
            ├── App.tsx             # React根组件
            ├── vite-env.d.ts       # Vite类型声明
            │
            └── examples/           ✅ 新增：使用示例
                └── ipc-usage-example.tsx  # IPC调用示例组件
```

---

## 模块说明

### 1. 共享类型 (`src/types/`)

**文件：** `ipc.ts`

**作用：** 定义主进程和渲染进程共享的类型

**包含内容：**
- 数据类型：`Article`, `Tag`, `SearchParams`, `SearchResult`, etc.
- IPC通道常量：`IPC_CHANNELS`
- API接口定义：`IpcApi`
- Window全局接口扩展

**特点：**
- ✅ 类型安全：所有IPC通信都有完整类型
- ✅ 单一真相源：避免类型重复定义
- ✅ 自动补全：IDE智能提示

---

### 2. 主进程 (`src/main/`)

#### 2.1 主入口 (`index.ts`)

**更新内容：**
- ✅ 导入IPC注册器
- ✅ 应用启动时注册所有IPC处理器
- ✅ 应用退出前清理IPC处理器
- ✅ 增强的窗口配置（安全性、性能）
- ✅ 完善的错误处理

**关键代码：**
```typescript
import { registerAllIpcHandlers, unregisterAllIpcHandlers } from './ipc';

app.whenReady().then(() => {
  registerAllIpcHandlers();  // 注册IPC
  createWindow();
});

app.on('before-quit', () => {
  unregisterAllIpcHandlers();  // 清理IPC
});
```

#### 2.2 IPC处理器 (`src/main/ipc/`)

**新增模块，处理所有IPC通信**

| 文件 | 功能 | IPC通道数 |
|-----|------|----------|
| `index.ts` | 统一注册器 | - |
| `article.ts` | 文章CRUD、采集、导出 | 7 |
| `tag.ts` | 标签管理、关联操作 | 6 |
| `search.ts` | 搜索、统计 | 3 |
| `system.ts` | 系统路径、外部链接 | 2 |

**特性：**
- ✅ 模块化：按功能拆分处理器
- ✅ 类型安全：完整的TypeScript类型
- ✅ 错误处理：统一的错误捕获和日志
- ✅ 输入验证：参数校验和安全检查

#### 2.3 数据库模块 (`src/main/database/`)

**状态：** 已有框架，待与IPC集成

**集成方式：**
```typescript
// IPC处理器调用数据库服务
import { ArticleDatabase } from '../database/article';

ipcMain.handle('article:getAll', async (_event, limit, offset) => {
  const db = new ArticleDatabase();
  return await db.getAll(limit, offset);
});
```

#### 2.4 爬虫模块 (`src/main/scrapers/`)

**状态：** 已有框架，待与IPC集成

**集成方式：**
```typescript
// IPC处理器调用爬虫服务
import { WechatScraper } from '../scrapers/wechat';

ipcMain.handle('article:scrape', async (_event, params) => {
  const scraper = new WechatScraper();
  return await scraper.scrape(params);
});
```

---

### 3. Preload脚本 (`src/preload/`)

**文件：** `index.ts`

**更新内容：**
- ✅ 完整的IPC API实现
- ✅ 白名单验证机制
- ✅ 类型安全包装
- ✅ 开发环境日志

**安全特性：**
```typescript
// 1. 白名单验证
const ALLOWED_CHANNELS = Object.values(IPC_CHANNELS);
function isValidChannel(channel: string): boolean {
  return ALLOWED_CHANNELS.includes(channel);
}

// 2. 安全调用包装
function safeInvoke<T>(channel: string, ...args: any[]): Promise<T> {
  if (!isValidChannel(channel)) {
    return Promise.reject(new Error('未授权的IPC通道'));
  }
  return ipcRenderer.invoke(channel, ...args);
}

// 3. contextBridge暴露
contextBridge.exposeInMainWorld('api', {
  getAllArticles: (limit, offset) =>
    safeInvoke(IPC_CHANNELS.ARTICLE_GET_ALL, limit, offset),
  // ... 更多API
});
```

**暴露的API数量：** 16个方法

---

### 4. 渲染进程 (`src/renderer/`)

#### 4.1 使用示例 (`src/renderer/src/examples/`)

**文件：** `ipc-usage-example.tsx`

**新增组件：**
1. `ArticleListExample` - 文章列表展示和删除
2. `ArticleScrapeExample` - 文章采集和进度监听
3. `SearchExample` - 文章搜索和建议
4. `TagManagementExample` - 标签管理

**特点：**
- ✅ 完整的CRUD示例
- ✅ 错误处理示例
- ✅ 加载状态管理
- ✅ React Hooks使用
- ✅ TypeScript类型安全

**使用方式：**
```typescript
// 在App.tsx中导入
import { ArticleListExample } from './examples/ipc-usage-example';

export default function App() {
  return <ArticleListExample />;
}
```

---

## IPC通信流程

```
渲染进程组件
    │
    │ 1. 调用 window.api.xxx()
    ▼
Preload脚本
    │
    │ 2. 白名单验证
    │ 3. safeInvoke()
    ▼
IPC通道 (安全隔离)
    │
    │ 4. ipcMain.handle()
    ▼
IPC处理器
    │
    │ 5. 参数验证
    │ 6. 业务逻辑
    ▼
数据库/爬虫服务
    │
    │ 7. 数据操作
    ▼
返回结果
    │
    │ 8. 错误处理
    │ 9. 返回渲染进程
    ▼
组件更新UI
```

---

## 技术栈

### 核心技术
- **Electron 28.x** - 桌面应用框架
- **React 18.x** - UI框架
- **TypeScript 5.x** - 类型安全
- **Vite 5.x** - 构建工具

### 主进程
- **better-sqlite3** - SQLite数据库
- **cheerio** - HTML解析（爬虫）
- **axios** - HTTP请求

### 渲染进程
- **Zustand** - 状态管理
- **TailwindCSS** - 样式框架

---

## 文件统计

### 新增文件（本次创建）

```
src/types/ipc.ts                          ✅ 151行
src/main/ipc/article.ts                   ✅ 205行
src/main/ipc/tag.ts                       ✅ 156行
src/main/ipc/search.ts                    ✅ 174行
src/main/ipc/system.ts                    ✅  89行
src/main/ipc/index.ts                     ✅  62行
src/preload/index.ts                      ✅ 172行（已更新）
src/main/index.ts                         ✅ 151行（已更新）
src/renderer/src/examples/ipc-usage-example.tsx  ✅ 412行
dosc/IPC通信架构文档.md                   ✅ 1200行
dosc/IPC-README.md                        ✅  350行
dosc/项目结构说明.md                      ✅ 本文档
```

**总计：** 3,272+ 行代码和文档

---

## 开发状态

### ✅ 已完成

1. **IPC通信架构**
   - ✅ 类型定义完整
   - ✅ Preload安全桥接
   - ✅ IPC处理器模块化
   - ✅ 主进程集成

2. **安全机制**
   - ✅ 上下文隔离
   - ✅ 沙箱模式
   - ✅ 通道白名单
   - ✅ 输入验证

3. **开发体验**
   - ✅ TypeScript类型安全
   - ✅ 完整的使用示例
   - ✅ 详细的架构文档
   - ✅ 开发日志系统

### 🚧 待完成

1. **数据库集成**
   - IPC处理器连接真实数据库
   - 实现完整的CRUD操作
   - 添加事务支持

2. **爬虫集成**
   - IPC处理器连接爬虫引擎
   - 实现进度回调
   - 添加错误重试

3. **导出服务**
   - Markdown导出
   - HTML导出
   - PDF导出（需要额外依赖）

4. **测试覆盖**
   - 单元测试
   - 集成测试
   - E2E测试

---

## 快速开始

### 1. 查看架构文档

```bash
# 详细架构说明
cat dosc/IPC通信架构文档.md

# 快速开始指南
cat dosc/IPC-README.md
```

### 2. 启动开发服务器

```bash
npm run dev
```

### 3. 测试IPC通信

打开浏览器控制台（F12）：

```javascript
// 测试文章API
await window.api.getAllArticles(10, 0);

// 测试标签API
await window.api.getAllTags();

// 测试搜索API
await window.api.searchArticles({ keyword: 'test' });
```

### 4. 查看示例组件

```typescript
// src/renderer/src/App.tsx
import { ArticleListExample } from './examples/ipc-usage-example';

export default function App() {
  return <ArticleListExample />;
}
```

---

## 下一步计划

### 第一阶段：数据库集成
1. 实现ArticleDatabase类
2. 实现TagDatabase类
3. 实现SearchService类
4. IPC处理器连接数据库

### 第二阶段：爬虫集成
1. 完善WechatScraper类
2. 实现采集进度回调
3. IPC处理器连接爬虫

### 第三阶段：功能完善
1. 实现导出服务
2. 添加错误处理
3. 性能优化

### 第四阶段：测试与文档
1. 编写单元测试
2. 编写集成测试
3. 完善用户文档

---

## 相关文档

- **需求文档：** `dosc/需求文档.md`
- **技术文档：** `dosc/技术文档.md`
- **IPC架构：** `dosc/IPC通信架构文档.md` ⭐
- **快速开始：** `dosc/IPC-README.md` ⭐
- **项目结构：** `dosc/项目结构说明.md` （本文档）

---

## 贡献指南

### 添加新的IPC功能

1. 在 `src/types/ipc.ts` 定义类型
2. 在 `src/main/ipc/` 创建处理器
3. 在 `src/main/ipc/index.ts` 注册
4. 在 `src/preload/index.ts` 暴露API
5. 在 `src/renderer/src/examples/` 添加示例

### 编码规范

- ✅ 使用TypeScript严格模式
- ✅ 遵循ESLint规则
- ✅ 添加必要的注释
- ✅ 编写单元测试

---

**最后更新：** 2025-10-06
**版本：** 1.0.0
**作者：** IPC通信架构团队
