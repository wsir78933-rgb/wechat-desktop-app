name: Release Build

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-windows:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      env:
        PIP_DISABLE_PIP_VERSION_CHECK: 1
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip --disable-pip-version-check
        pip install --disable-pip-version-check -r requirements.txt
        pip install --disable-pip-version-check pyinstaller

    - name: Create PyInstaller spec file
      run: |
        $specContent = @"
        # -*- mode: python ; coding: utf-8 -*-
        import os
        import sys

        project_root = os.path.abspath('.')
        src_path = os.path.join(project_root, 'src', 'main', 'python')

        hidden_imports = [
            'PyQt5',
            'PyQt5.QtCore',
            'PyQt5.QtGui',
            'PyQt5.QtWidgets',
            'PyQt5.sip',
            # UI模块
            'ui',
            'ui.main_window',
            'ui.styles',
            'ui.widgets',
            'ui.widgets.account_list_widget',
            'ui.widgets.article_list_widget',
            'ui.dialogs',
            'ui.dialogs.add_account_dialog',
            'ui.dialogs.add_article_dialog',
            # Core模块
            'core',
            'core.database',
            'core.account_manager',
            'core.article_manager',
            'core.export_manager',
            'core.import_manager',
            # Utils模块
            'utils',
            'utils.logger',
            'utils.config',
            'utils.validators',
            # 标准库
            'logging',
            'sqlite3',
            'json',
            'datetime',
            # 第三方库
            'openpyxl',
            'openpyxl.styles',
            'openpyxl.utils',
            'validators',
            'dateutil',
            'dateutil.parser',
        ]

        a = Analysis(
            ['src\\main\\python\\main.py'],
            pathex=[src_path],
            binaries=[],
            datas=[],
            hiddenimports=hidden_imports,
            hookspath=[],
            hooksconfig={},
            runtime_hooks=[],
            excludes=[],
            win_no_prefer_redirects=False,
            win_private_assemblies=False,
            cipher=None,
            noarchive=False,
        )

        pyz = PYZ(a.pure, a.zipped_data, cipher=None)

        exe = EXE(
            pyz,
            a.scripts,
            a.binaries,
            a.zipfiles,
            a.datas,
            [],
            name='对标账号管理软件',
            debug=False,
            bootloader_ignore_signals=False,
            strip=False,
            upx=True,
            upx_exclude=[],
            runtime_tmpdir=None,
            console=False,
            disable_windowed_traceback=False,
            argv_emulation=False,
            target_arch=None,
            codesign_identity=None,
            entitlements_file=None,
            icon='icon.ico',
        )
        "@
        $specContent | Out-File -FilePath "build.spec" -Encoding utf8

    - name: Build Windows executable
      run: |
        pyinstaller --clean build.spec

    - name: Create ZIP archive
      run: |
        Compress-Archive -Path dist/对标账号管理软件.exe -DestinationPath 对标账号管理软件-windows.zip

    - name: Upload to Release
      uses: softprops/action-gh-release@v1
      with:
        files: 对标账号管理软件-windows.zip
        body: |
          ## 对标账号管理软件 - Windows版本

          ### 安装说明
          1. 下载 `对标账号管理软件-windows.zip`
          2. 解压到任意目录
          3. 双击 `对标账号管理软件.exe` 运行

          ### 功能特性
          - 账号管理（添加、编辑、删除）
          - 文章管理（添加、编辑、删除、搜索）
          - 数据导入（Excel、JSON）
          - 数据导出（Excel、JSON、Markdown）
          - 左右分栏界面
          - Material Design风格

          ### 技术栈
          - Python 3.10
          - PyQt5
          - SQLite3
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
