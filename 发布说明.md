# 📦 发布说明

## 如何创建新版本

GitHub Actions 会在推送 tag 时自动构建并发布 Windows 可执行文件。

### 方法一：使用命令行

```bash
# 1. 确保所有修改已提交
git add .
git commit -m "你的提交信息"
git push origin main

# 2. 创建并推送 tag（触发自动构建）
git tag v1.0.1
git push origin v1.0.1
```

### 方法二：使用 GitHub 网页

1. 访问仓库页面
2. 点击右侧的 "Releases"
3. 点击 "Draft a new release"
4. 填写信息：
   - **Tag version**: v1.0.1 (必须以 v 开头)
   - **Release title**: 对标账号管理软件 v1.0.1
   - **Description**: 版本更新说明
5. 点击 "Publish release"

## 版本号规范

使用语义化版本号：`v主版本号.次版本号.修订号`

- **主版本号**：重大功能变更或不兼容的 API 修改
- **次版本号**：向下兼容的功能新增
- **修订号**：向下兼容的问题修正

示例：
- `v1.0.0` - 首次正式发布
- `v1.0.1` - 修复 bug
- `v1.1.0` - 添加新功能
- `v2.0.0` - 重大更新

## 自动构建流程

当推送 tag 时，GitHub Actions 会：

1. ✅ 检出代码
2. ✅ 安装 Python 3.10 和依赖
3. ✅ 使用 PyInstaller 打包为单文件 exe
4. ✅ 创建 ZIP 压缩包
5. ✅ 上传到 GitHub Releases

构建完成后，用户可以在 Releases 页面下载 `对标账号管理软件-windows.zip`。

## 已修复的问题

### v1.0.1 修复内容

✅ **修复打包错误** - 解决 "No module named 'ui'" 错误
- 更新 PyInstaller 的 hiddenimports 配置
- 添加所有子模块（ui.widgets, ui.dialogs, core.*, utils.*）
- 添加必要的第三方库依赖

**技术细节**:
- PyInstaller 需要显式声明所有动态导入的模块
- 之前的配置只包含顶层模块 `ui`、`core`、`utils`
- 现在包含完整的子模块列表：
  - `ui.widgets.account_list_widget`
  - `ui.widgets.article_list_widget`
  - `ui.dialogs.add_account_dialog`
  - `ui.dialogs.add_article_dialog`
  - `core.database`, `core.account_manager`, `core.article_manager`, `core.export_manager`
  - `utils.logger`, `utils.config`, `utils.validators`
  - 第三方库：`openpyxl.styles`, `dateutil.parser` 等

## 本地测试打包

如需本地测试打包流程：

```bash
# 1. 安装 PyInstaller
pip install pyinstaller

# 2. 运行打包脚本（Windows）
build.bat

# 或手动执行
pyinstaller --clean build.spec
```

打包成功后，可执行文件位于 `dist/对标账号管理软件.exe`。

## 注意事项

1. **Tag 必须以 `v` 开头**，如 `v1.0.0`，否则不会触发构建
2. **不要删除已发布的 tag**，会导致版本历史混乱
3. **每次发布前先在本地测试**，确保功能正常
4. **构建需要 5-10 分钟**，可在 Actions 标签页查看进度

## 下载和使用

发布后，用户可以选择两种下载方式：

### 方式一：安装程序版本（推荐）

1. 访问项目的 Releases 页面
2. 下载 `对标账号管理软件-setup-*.exe`
3. 双击运行安装向导
4. 按照提示完成安装
5. 从开始菜单或桌面快捷方式启动

**优势：**
- ✅ 自动创建开始菜单快捷方式
- ✅ 可选择创建桌面快捷方式
- ✅ 完整的卸载功能
- ✅ 专业的安装向导界面
- ✅ 自动管理文件路径

### 方式二：便携版本（zip）

1. 访问项目的 Releases 页面
2. 下载 `对标账号管理软件-windows.zip`
3. 解压到任意目录
4. 双击 `对标账号管理软件.exe` 运行

**优势：**
- ✅ 无需安装，解压即用
- ✅ 可放在U盘等移动设备
- ✅ 不在系统中留下注册表项

### ⚠️ 杀毒软件误报说明

**如果 Windows Defender 或其他杀毒软件提示病毒警告，这是误报（False Positive），请放心使用。**

#### 为什么会误报？
- ✅ PyInstaller 使用压缩和自解压技术（与某些恶意软件特征相似）
- ✅ 可执行文件未进行代码签名（需要购买证书，约 $300-500/年）
- ✅ 包含完整 Python 解释器（体积较大，约50MB）

#### 如何验证安全性？
1. **查看 GitHub Actions 构建日志** - 所有构建过程透明可审计
2. **检查源代码** - 完全开源，没有恶意代码
3. **VirusTotal 扫描** - 上传到 https://www.virustotal.com/ 进行多引擎扫描

#### 如何解决误报？
```powershell
# 方法1: 添加到 Windows Defender 白名单
Windows 安全中心 → 病毒和威胁防护 → 排除项 → 添加文件

# 方法2: 下载后右键 → 属性 → 解除阻止
右键 .zip 文件 → 属性 → 勾选"解除阻止" → 应用
```

### 首次运行

首次运行时，程序会自动创建：
- `data/` - 数据库文件
- `logs/` - 日志文件

## 常见问题

### Q: 构建失败怎么办？

A: 检查 Actions 页面的构建日志，常见问题：
- 依赖安装失败 → 检查 requirements.txt
- 打包失败 → 检查 hiddenimports 配置
- 上传失败 → 检查 GitHub token 权限

### Q: 如何添加新的模块到打包？

A: 编辑两个文件：
1. `.github/workflows/release.yml` - 在 `hidden_imports` 列表中添加
2. `build.spec` - 在 `hidden_imports` 列表中添加

### Q: 打包后的 exe 太大？

A: 可以优化：
- 移除不必要的依赖
- 使用 `excludes` 排除不需要的模块
- 使用 `--strip` 参数（已启用 UPX 压缩）

## 本地构建安装程序

如果你想在本地构建 setup.exe 安装程序：

### 前置要求

1. **安装 Inno Setup**
   - 下载地址: https://jrsoftware.org/isdl.php
   - 推荐下载: `innosetup-6.x.x.exe` (Unicode 版本)
   - 安装到默认位置: `C:\Program Files (x86)\Inno Setup 6\`

2. **安装 Python 和依赖**
   ```bash
   pip install -r requirements.txt
   pip install pyinstaller
   ```

### 构建步骤

**方式一：使用自动化脚本（推荐）**
```bash
# 运行构建脚本（会自动执行 PyInstaller 和 Inno Setup）
build_installer.bat
```

**方式二：手动构建**
```bash
# 1. 使用 PyInstaller 打包 exe
build.bat
# 或
pyinstaller --clean build.spec

# 2. 使用 Inno Setup 编译安装程序
"C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer.iss
```

构建完成后，安装程序位于 `output/installer/对标账号管理软件-setup-*.exe`

## 版本历史

- **v1.2.0** (2025-10-08) - 添加 setup.exe 安装程序支持
- **v1.0.1** (2025-10-08) - 修复 PyInstaller 打包配置
- **v1.0.0** (2025-10-07) - 首次发布
